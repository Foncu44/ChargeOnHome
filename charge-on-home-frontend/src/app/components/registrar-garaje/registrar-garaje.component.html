<div class="registrar-garaje-container">
  <!-- Header -->
  <mat-toolbar color="primary" class="app-toolbar">
    <button mat-icon-button routerLink="/mapa" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <span class="logo">
      <mat-icon>add_home</mat-icon>
      Registrar Garaje
    </span>
    <span class="spacer"></span>
  </mat-toolbar>

  <!-- Contenido principal -->
  <div class="main-content">
    <div class="form-container">
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>home</mat-icon>
            Información del Garaje
          </mat-card-title>
          <mat-card-subtitle>Completa todos los campos para publicar tu garaje</mat-card-subtitle>
        </mat-card-header>

        <form [formGroup]="garajeForm" (ngSubmit)="onSubmit()">
          <mat-card-content>
            <!-- Sección: Ubicación -->
            <div class="form-section">
              <h3 class="section-title">
                <mat-icon>location_on</mat-icon>
                Ubicación
              </h3>
              
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Dirección</mat-label>
                <input matInput formControlName="direccion" placeholder="Calle, número, ciudad">
                <mat-icon matSuffix>location_city</mat-icon>
                <mat-error *ngIf="garajeForm.get('direccion')?.hasError('required')">
                  La dirección es obligatoria
                </mat-error>
              </mat-form-field>

              <!-- Mapa para seleccionar ubicación -->
              <div class="map-section">
                <p class="map-instructions">
                  <mat-icon>info</mat-icon>
                  Haz clic en el mapa para seleccionar la ubicación exacta
                </p>
                <div class="map-container">
                  <google-map
                    [center]="center"
                    [zoom]="zoom"
                    [options]="mapOptions"
                    (mapClick)="onMapClick($event)"
                    width="100%"
                    height="400px">
                    <map-marker
                      *ngIf="markerPosition"
                      [position]="markerPosition"
                      [options]="{ draggable: true }"
                      (mapClick)="onMapClick($any($event))">
                    </map-marker>
                  </google-map>
                </div>
                <div class="coordinates-info" *ngIf="markerPosition">
                  <mat-icon>my_location</mat-icon>
                  <span>Lat: {{ markerPosition.lat | number:'1.6-6' }}, Lng: {{ markerPosition.lng | number:'1.6-6' }}</span>
                </div>
              </div>
            </div>

            <!-- Sección: Dimensiones -->
            <div class="form-section">
              <h3 class="section-title">
                <mat-icon>straighten</mat-icon>
                Dimensiones
              </h3>
              
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field-third">
                  <mat-label>Ancho (m)</mat-label>
                  <input matInput type="number" formControlName="ancho" step="0.1" min="1" max="10">
                  <mat-icon matSuffix>height</mat-icon>
                  <mat-error *ngIf="garajeForm.get('ancho')?.hasError('required')">
                    Obligatorio
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field-third">
                  <mat-label>Largo (m)</mat-label>
                  <input matInput type="number" formControlName="largo" step="0.1" min="1" max="20">
                  <mat-icon matSuffix>height</mat-icon>
                  <mat-error *ngIf="garajeForm.get('largo')?.hasError('required')">
                    Obligatorio
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field-third">
                  <mat-label>Altura (m)</mat-label>
                  <input matInput type="number" formControlName="altura" step="0.1" min="1.5" max="5">
                  <mat-icon matSuffix>height</mat-icon>
                  <mat-error *ngIf="garajeForm.get('altura')?.hasError('required')">
                    Obligatorio
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="area-info">
                <mat-icon>square_foot</mat-icon>
                <span>Área total: <strong>{{ calcularArea() | number:'1.2-2' }} m²</strong></span>
              </div>
            </div>

            <!-- Sección: Precios -->
            <div class="form-section">
              <h3 class="section-title">
                <mat-icon>euro</mat-icon>
                Precios
              </h3>
              
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field-half">
                  <mat-label>Precio por hora (€)</mat-label>
                  <input matInput type="number" formControlName="precioPorHora" step="0.01" min="0.01">
                  <span matSuffix>€/h</span>
                  <mat-icon matPrefix>attach_money</mat-icon>
                  <mat-error *ngIf="garajeForm.get('precioPorHora')?.hasError('required')">
                    Obligatorio
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field-half">
                  <mat-label>Precio electricidad (€/kWh)</mat-label>
                  <input matInput type="number" formControlName="precioElectricidad" step="0.001" min="0.01">
                  <span matSuffix>€/kWh</span>
                  <mat-icon matPrefix>bolt</mat-icon>
                  <mat-error *ngIf="garajeForm.get('precioElectricidad')?.hasError('required')">
                    Obligatorio
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="price-note">
                <mat-icon>info</mat-icon>
                <span>El precio mostrado incluirá un 20% de comisión de gestión de la plataforma</span>
              </div>
            </div>

            <!-- Sección: Equipamiento -->
            <div class="form-section">
              <h3 class="section-title">
                <mat-icon>electrical_services</mat-icon>
                Equipamiento de Carga
              </h3>
              
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Tipo de Conector</mat-label>
                <mat-select formControlName="tipoConector">
                  <mat-option *ngFor="let tipo of tiposConector" [value]="tipo.value">
                    {{ tipo.label }}
                  </mat-option>
                </mat-select>
                <mat-icon matSuffix>power</mat-icon>
                <mat-error *ngIf="garajeForm.get('tipoConector')?.hasError('required')">
                  Debes seleccionar un tipo de conector
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Potencia de Carga (kW)</mat-label>
                <input matInput type="number" formControlName="potenciaCarga" step="0.1" min="3.7">
                <mat-icon matSuffix>flash_on</mat-icon>
                <mat-hint>Mínimo 3.7 kW (Schuko), típico 11-22 kW (Tipo 2), rápido 50+ kW (CCS/CHAdeMO)</mat-hint>
                <mat-error *ngIf="garajeForm.get('potenciaCarga')?.hasError('required')">
                  Obligatorio
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Sección: Disponibilidad -->
            <div class="form-section">
              <h3 class="section-title">
                <mat-icon>schedule</mat-icon>
                Disponibilidad
              </h3>
              
              <mat-checkbox formControlName="disponible24h" class="full-width checkbox-large">
                Disponible 24 horas
              </mat-checkbox>

              <div class="horarios-section" *ngIf="!garajeForm.get('disponible24h')?.value">
                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field-half">
                    <mat-label>Horario inicio</mat-label>
                    <input matInput type="time" formControlName="horarioInicio">
                    <mat-icon matSuffix>schedule</mat-icon>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field-half">
                    <mat-label>Horario fin</mat-label>
                    <input matInput type="time" formControlName="horarioFin">
                    <mat-icon matSuffix>schedule</mat-icon>
                  </mat-form-field>
                </div>
              </div>
            </div>

            <!-- Sección: Descripción y Fotos -->
            <div class="form-section">
              <h3 class="section-title">
                <mat-icon>description</mat-icon>
                Descripción y Fotos
              </h3>
              
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Descripción</mat-label>
                <textarea matInput formControlName="descripcion" rows="4" 
                          placeholder="Describe tu garaje, accesos, características especiales..."></textarea>
                <mat-hint>{{ garajeForm.get('descripcion')?.value?.length || 0 }}/1000 caracteres</mat-hint>
              </mat-form-field>

              <div class="fotos-section">
                <label class="fotos-label">
                  <input type="file" multiple accept="image/*" (change)="onFotosSeleccionadas($event)" style="display: none;">
                  <button mat-raised-button color="accent" type="button">
                    <mat-icon>add_photo_alternate</mat-icon>
                    Agregar Fotos (máx. 10)
                  </button>
                </label>

                <div class="fotos-preview" *ngIf="fotosPreview.length > 0">
                  <div class="foto-item" *ngFor="let foto of fotosPreview; let i = index">
                    <img [src]="foto" alt="Preview">
                    <button mat-icon-button class="delete-foto" (click)="eliminarFoto(i)">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </mat-card-content>

          <mat-card-actions class="form-actions">
            <button mat-button type="button" routerLink="/mapa" class="cancel-button">
              <mat-icon>cancel</mat-icon>
              Cancelar
            </button>
            <button mat-raised-button color="primary" type="submit" [disabled]="isLoading || !markerPosition">
              <mat-spinner *ngIf="isLoading" diameter="20" class="button-spinner"></mat-spinner>
              <mat-icon *ngIf="!isLoading">publish</mat-icon>
              {{ isLoading ? 'Publicando...' : 'Publicar Garaje' }}
            </button>
          </mat-card-actions>
        </form>
      </mat-card>
    </div>
  </div>
</div>
